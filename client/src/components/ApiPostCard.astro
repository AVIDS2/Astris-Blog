---
/**
 * API Post Card - 适配 API 数据的文章卡片组件
 * 用于 SSR 模式，从 API 获取的文章数据
 */
import { Icon } from "astro-icon/components";
import { siteConfig } from "../config";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import type { ApiPostList } from "@utils/api-client";

interface Props {
	class?: string;
	post: ApiPostList;
	style?: string;
}

const { post, style } = Astro.props;
const className = Astro.props.class;

const {
	title,
	slug,
	summary,
	cover_image,
	is_pinned,
	created_at,
	category,
	tags,
} = post;

const url = `/posts/${slug}/`;
const hasCover = cover_image !== undefined && cover_image !== null && cover_image !== "";
const coverWidth = "28%";

// 格式化日期
const publishDate = new Date(created_at);
const formattedDate = publishDate.toLocaleDateString('zh-CN', {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit'
});
---

<div
	class:list={[
		"card-base flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative",
		className,
	]}
	style={style}
>
	<div
		class:list={[
			"pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 relative",
			{
				"w-full md:w-[calc(100%_-_52px_-_12px)]": !hasCover,
				"w-full md:w-[calc(100%_-_var(--coverWidth)_-_12px)]": hasCover,
			},
		]}
	>
		<a
			href={url}
			class="transition group w-full block font-bold mb-3 text-3xl text-90
        hover:text-[var(--primary)] dark:hover:text-[var(--primary)]
        active:text-[var(--title-active)] dark:active:text-[var(--title-active)]
        before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
        before:absolute
        before:top-[35px] before:left-[18px] before:hidden md:before:block"
		>
			{
				is_pinned && (
					<Icon
						name="mdi:pin"
						class="inline text-[var(--primary)] text-2xl mr-2 -translate-y-0.5"
					/>
				)
			}
			{title}
			<Icon
				class="inline text-[2rem] text-[var(--primary)] md:hidden translate-y-0.5 absolute"
				name="material-symbols:chevron-right-rounded"
			/>
			<Icon
				class="text-[var(--primary)] text-[2rem] transition hidden md:inline absolute translate-y-0.5 opacity-0 group-hover:opacity-100 -translate-x-1 group-hover:translate-x-0"
				name="material-symbols:chevron-right-rounded"
			/>
		</a>

		<!-- 文章元信息 -->
		<div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-500 dark:text-gray-400 mb-4">
			<span class="flex items-center gap-1">
				<Icon name="material-symbols:calendar-today-outline-rounded" class="text-base" />
				{formattedDate}
			</span>
			{category && (
				<a href={`/categories/${category.slug}/`} class="flex items-center gap-1 hover:text-[var(--primary)]">
					<Icon name="material-symbols:folder-outline-rounded" class="text-base" />
					{category.name}
				</a>
			)}
		</div>

		<div
			class:list={[
				"transition text-75 mb-3.5 pr-4 line-clamp-2 md:line-clamp-1",
			]}
		>
			{summary || "暂无摘要"}
		</div>

		<div class="flex flex-wrap gap-2 mt-2">
			{
				tags && tags.length > 0 ? (
					tags.map((tag) => (
						<a
							href={`/tags/${tag.slug}/`}
							class:list={[
								siteConfig.tagStyle?.useNewStyle
									? "link-lg transition text-50 text-xs font-medium px-2 py-1 rounded-lg hover:text-[var(--primary)] dark:hover:text-[var(--primary)] active:text-[var(--primary)] dark:active:text-[var(--primary)] group/tag whitespace-nowrap"
									: "btn-regular h-6 text-xs px-2 rounded-lg",
							]}
							aria-label={`View all posts tagged with ${tag.name}`}
						>
							<span class="transition-transform group-hover/tag:translate-x-0.5">
								# {tag.name}
							</span>
						</a>
					))
				) : (
					<span class="text-xs text-50">{i18n(I18nKey.noTags)}</span>
				)
			}
		</div>
	</div>

	{
		hasCover && (
			<a
				href={url}
				aria-label={title}
				class:list={[
					"group",
					"max-h-[20vh] md:max-h-none mx-4 mt-4 -mb-2 md:mb-0 md:mx-0 md:mt-0",
					"md:w-[var(--coverWidth)] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-95",
				]}
			>
				<div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition" />
				<div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center ">
					<Icon
						name="material-symbols:chevron-right-rounded"
						class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl"
					/>
				</div>
				<img
					src={cover_image}
					alt="Cover Image of the Post"
					class="w-full h-full object-cover"
				/>
			</a>
		)
	}

	{
		!hasCover && (
			<a
				href={url}
				aria-label={title}
				class="!hidden md:!flex btn-regular w-[3.25rem]
         absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)]
         hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95
        "
			>
				<Icon
					name="material-symbols:chevron-right-rounded"
					class="transition text-[var(--primary)] text-4xl mx-auto"
				/>
			</a>
		)
	}
</div>
<div
	class="transition border-t-[1px] border-dashed mx-6 border-black/10 dark:border-white/[0.15] last:border-t-0 md:hidden"
>
</div>

<style define:vars={{ coverWidth }}></style>
