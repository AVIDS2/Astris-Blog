---
export const prerender = false;

import { siteConfig } from "../../../config";
import I18nKey from "../../../i18n/i18nKey";
import { i18n } from "../../../i18n/translation";
import MainGridLayout from "../../../layouts/MainGridLayout.astro";
import { API_BASE } from "../../../utils/api-client";

// æ£€æŸ¥ç›¸å†Œé¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.featurePages.albums) {
	return Astro.redirect("/404/");
}

const { id } = Astro.params;

// ä» API è·å–ç›¸å†Œè¯¦æƒ…
interface Photo {
	id: number;
	url: string;
	thumbnail: string | null;  // ç¼©ç•¥å›¾ URL
	title: string | null;
	description: string | null;
}

interface AlbumDetail {
	id: number;
	name: string;
	description: string | null;
	photos: Photo[];
}

let album: AlbumDetail | null = null;
try {
	const res = await fetch(`${API_BASE}/api/albums/${id}`);
	if (res.ok) {
		album = await res.json();
	}
} catch (e) {
	console.error('Failed to fetch album:', e);
}

if (!album) {
	return Astro.redirect("/404/");
}
---

<MainGridLayout title={album.name} description={album.description || album.name}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      
      <!-- è¿”å›æŒ‰é’® -->
      <div class="mb-6">
        <a 
          href="/albums/" 
          class="inline-flex items-center gap-2 text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          è¿”å›ç›¸å†Œåˆ—è¡¨
        </a>
      </div>

      <!-- ç›¸å†Œæ ‡é¢˜ä¿¡æ¯ -->
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3">
          {album.name}
        </h1>
        
        {album.description && (
          <p class="text-neutral-600 dark:text-neutral-400 mb-4">
            {album.description}
          </p>
        )}
        
        <!-- ç›¸å†Œå…ƒæ•°æ® -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-neutral-500 dark:text-neutral-500">
          <span>{album.photos.length} å¼ ç…§ç‰‡</span>
        </div>
      </header>

      <!-- ç…§ç‰‡ç½‘æ ¼ -->
      {album.photos.length > 0 ? (
        <div class="photo-gallery grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {album.photos.map((photo) => {
            // ä½¿ç”¨ç¼©ç•¥å›¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°åŸå›¾
            const thumbUrl = photo.thumbnail 
              ? `${API_BASE}${photo.thumbnail}`
              : `${API_BASE}${photo.url}`;
            const fullUrl = `${API_BASE}${photo.url}`;
            
            return (
              <figure class="photo-item group relative overflow-hidden rounded-lg aspect-square bg-gray-100 dark:bg-gray-800">
                <a 
                  href={fullUrl}
                  data-fancybox="gallery"
                  data-caption={photo.title || ''}
                  class="block w-full h-full"
                >
                  <img 
                    src={thumbUrl}
                    alt={photo.title || ''}
                    class="photo-image w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer"
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              </figure>
            );
          })}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="text-6xl opacity-30 mb-4">ğŸ“·</div>
          <p class="text-neutral-500">è¿™ä¸ªç›¸å†Œè¿˜æ²¡æœ‰ç…§ç‰‡</p>
        </div>
      )}
    </div>
  </div>

</MainGridLayout>

<script>
  // ç¡®ä¿Fancyboxæ­£ç¡®å¤„ç†ç›¸å†Œå›¾ç‰‡
  document.addEventListener('DOMContentLoaded', () => {
    console.log('=== ç›¸å†Œé¡µé¢åŠ è½½å®Œæˆ ===');
    
    // æ£€æŸ¥é¡µé¢ä¸­çš„å›¾ç‰‡å…ƒç´ 
    const albumImages = document.querySelectorAll('.photo-gallery img');
    console.log('ç›¸å†Œå›¾ç‰‡æ•°é‡:', albumImages.length);
  });
</script>

<style>
  .photo-item {
    animation: fadeIn 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>
