---
import { getEntry, render } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";
// import Icon from "../components/misc/Icon.astro";
import { siteConfig } from "../config";
import { getShuffledFriendsList } from "../data/friends";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// 检查友链页面是否启用
if (!siteConfig.featurePages.friends) {
	return Astro.redirect("/404/");
}

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
	throw new Error("friends page content not found");
}

const { Content } = await render(friendsPost);

// 定义友链类型
interface FriendItem {
	id?: number;
	name: string;
	url: string;
	avatar?: string;
	description?: string;
	tags: string[];
	sort_order?: number;
}

// 从 API 获取友链，失败时使用本地配置
async function getFriendsFromApi(): Promise<FriendItem[]> {
	try {
		// 判断是否在本地运行（开发或预览模式）
		const isLocal = import.meta.env.DEV || 
			(typeof process !== 'undefined' && process.env.NODE_ENV !== 'production') ||
			siteConfig.siteURL.includes('localhost') ||
			siteConfig.siteURL.includes('127.0.0.1');
		
		// 本地环境使用 localhost:8000，生产环境使用站点 URL
		const apiUrl = isLocal 
			? 'http://localhost:8000/api/friends'
			: `${siteConfig.siteURL.replace(/\/$/, '')}/api/friends`;
		
		console.log('[Friends] Fetching from:', apiUrl);
		
		const res = await fetch(apiUrl, { 
			signal: AbortSignal.timeout(5000) 
		});
		
		if (res.ok) {
			const data = await res.json();
			console.log('[Friends] Got', data.length, 'friends from API');
			// 转换 API 返回格式（tags 是逗号分隔的字符串）
			return data.map((item: any) => ({
				...item,
				tags: item.tags ? item.tags.split(',').map((t: string) => t.trim()).filter(Boolean) : []
			}));
		}
		console.log('[Friends] API returned status:', res.status);
	} catch (e) {
		console.log('[Friends] Failed to fetch from API:', e);
	}
	return [];
}

// 优先使用 API，无数据时使用本地配置
let friendsList: FriendItem[] = await getFriendsFromApi();
if (friendsList.length === 0) {
	friendsList = getShuffledFriendsList();
}

// 获取所有标签
const allTags = Array.from(new Set(friendsList.flatMap((item) => item.tags)));
---

<MainGridLayout title={i18n(I18nKey.friends)} description={i18n(I18nKey.friends)}>
	<!-- 只在友情链接页面加载脚本 -->
	<script is:inline>
		// 标记当前页面为友情链接页面
		window.isFriendsPage = true;
		
		// 标签展开/折叠功能
		document.addEventListener('DOMContentLoaded', function() {
			const toggleBtn = document.getElementById('toggle-tags-btn');
			const filterContainer = document.getElementById('filter-container');
			const toggleText = document.getElementById('toggle-tags-text');
			const toggleIcon = document.getElementById('toggle-tags-icon');
			
			if (toggleBtn && filterContainer) {
				let isExpanded = false;
				
				toggleBtn.addEventListener('click', function() {
					isExpanded = !isExpanded;
					
					if (isExpanded) {
						filterContainer.style.maxHeight = filterContainer.scrollHeight + 'px';
						toggleText.textContent = '收起';
						toggleIcon.style.transform = 'rotate(180deg)';
					} else {
						filterContainer.style.maxHeight = '44px';
						toggleText.textContent = '展开全部 (' + (filterContainer.querySelectorAll('.filter-tag').length - 1) + ')';
						toggleIcon.style.transform = 'rotate(0deg)';
					}
				});
			}
		});
	</script>
  <script>
    import('../scripts/right-sidebar-layout.js');
  </script>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
		<div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题 -->
      <div class="flex flex-col items-start justify-center mb-8">
        <h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
                  before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                  before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
          {i18n(I18nKey.friends)}
        </h1>
        <p class="text-lg text-black/60 dark:text-white/60">
          {i18n(I18nKey.friendsSubtitle)}
        </p>
			</div>

			<!-- 搜索和筛选栏 -->
			<div class="mb-6 space-y-3">
				<!-- 搜索框 -->
				<div class="w-full">
					<div class="relative">
						<input 
							type="text" 
							id="friend-search"
							placeholder={i18n(I18nKey.friendsSearchPlaceholder)}
							class="w-full px-4 py-2 pl-10 rounded-lg bg-[var(--btn-regular-bg)] 
									text-black/90 dark:text-white/90
									border border-black/10 dark:border-white/10
									focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50
									transition-all duration-200"
						/>
						<svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-black/40 dark:text-white/40" 
							 fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
								d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
						</svg>
					</div>
				</div>

				<!-- 标签筛选（可折叠） -->
				<div class="filter-wrapper">
					<div id="filter-container" class="filter-container flex flex-wrap gap-2 overflow-hidden transition-all duration-300" style="max-height: 44px;">
						<button 
							class="filter-tag active"
							data-tag="all"
						>
							{i18n(I18nKey.friendsFilterAll)}
						</button>
						{allTags.map(tag => (
							<button 
								class="filter-tag"
								data-tag={tag}
							>
								{tag}
							</button>
						))}
					</div>
					{allTags.length > 8 && (
						<button 
							id="toggle-tags-btn"
							class="mt-2 text-sm text-[var(--primary)] hover:text-[var(--primary)]/80 
								   flex items-center gap-1 transition-colors duration-200"
						>
							<span id="toggle-tags-text">展开全部 ({allTags.length})</span>
							<svg id="toggle-tags-icon" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
							</svg>
						</button>
					)}
				</div>
			</div>

			<!-- 友链卡片网格 -->
			<div id="friends-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
				{friendsList.map((item) => (
					<div 
						class="friend-card group relative bg-transparent rounded-xl border border-black/10 dark:border-white/10
								 overflow-hidden transition-all duration-300
								 hover:shadow-xl hover:-translate-y-1"
						data-title={(item.name || '').toLowerCase()}
						data-desc={(item.description || '').toLowerCase()}
						data-tags={item.tags.join(',')}
					>
						<!-- 卡片内容 -->
						<div class="p-6">
							<!-- 头像和标题区 -->
							<div class="flex items-start gap-4 mb-4">
								<!-- 网站图标 -->
								<div class="w-16 h-16 flex-shrink-0 rounded-xl overflow-hidden 
												bg-[var(--btn-regular-bg)] 
												ring-2 ring-transparent
												transition-all duration-300">
									<img 
										src={item.avatar || '/images/default-avatar.png'} 
										alt={item.name}
										class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-300"
										loading="lazy"
									/>
								</div>

								<!-- 标题和链接 -->
								<div class="flex-1 min-w-0">
									<h3 class="text-xl font-bold text-black/90 dark:text-white/90 mb-1 truncate
												 group-hover:text-[var(--primary)] transition-colors duration-200">
										{item.name}
									</h3>
									<a 
										href={item.url} 
										target="_blank" 
										rel="noopener noreferrer"
										class="text-xs text-black/50 dark:text-white/50 hover:text-[var(--primary)] 
												 truncate block transition-colors duration-200"
									>
										{(() => { try { return new URL(item.url).hostname; } catch { return item.url; } })()}
									</a>
								</div>
							</div>

							<!-- 描述 -->
							<p class="text-sm text-black/60 dark:text-white/60 mb-4 line-clamp-2 min-h-[2.5rem]">
								{item.description || '暂无描述'}
							</p>

							<!-- 标签 -->
							<div class="flex flex-wrap gap-2 mb-4">
								{item.tags.map(tag => (
									<span class="px-2 py-1 text-xs rounded-md 
													bg-[var(--primary)]/10 text-[var(--primary)] 
													font-medium">
										{tag}
									</span>
								))}
							</div>

							<!-- 操作按钮 -->
							<div class="flex gap-2">
								<a 
									href={item.url}
									target="_blank"
									rel="noopener noreferrer"
									class="flex-1 flex items-center justify-center gap-2 px-4 py-2 
											 rounded-lg bg-[var(--primary)] text-white 
											 hover:bg-[var(--primary)]/90 
											 active:scale-95 transition-all duration-200
											 font-medium text-sm"
								>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
											d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
									</svg>
									{i18n(I18nKey.friendsVisit)}
								</a>
								<button 
									class="copy-link-btn px-3 py-2 rounded-lg 
											 bg-[var(--btn-regular-bg)] 
											 hover:bg-[var(--btn-regular-bg-hover)] 
											 active:scale-95 transition-all duration-200
											 text-black/70 dark:text-white/70"
									data-url={item.url}
									title={i18n(I18nKey.friendsCopyLink)}
								>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
											d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
									</svg>
								</button>
							</div>
						</div>

						<!-- 悬停装饰效果 -->
						<div class="absolute inset-0 bg-gradient-to-br from-[var(--primary)]/5 to-transparent 
										opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
						</div>
					</div>
				))}
			</div>

			<!-- 无结果提示 -->
			<div id="no-results" class="hidden text-center py-12">
				<svg class="w-16 h-16 mx-auto mb-4 text-black/20 dark:text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
						d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
				</svg>
				<p class="text-black/50 dark:text-white/50 text-lg">{i18n(I18nKey.friendsNoResults)}</p>
			</div>

			<!-- 说明文档 -->
			<Markdown class="mt-8 prose dark:prose-invert max-w-none">
				<Content />
			</Markdown>
			
			<!-- 隐藏元素用于传递 i18n 文本到全局脚本 -->
			<div id="friends-copy-success-text" style="display: none;">{i18n(I18nKey.friendsCopySuccess)}</div>
		</div>
	</div>
	
	<!-- 引用全局脚本 -->
	<script is:inline src="/js/friends-page-handler.js"></script>
</MainGridLayout>

<style>
	/* 友链卡片动画 */
	.friend-card {
		animation: fadeInUp 0.5s ease-out forwards;
		opacity: 0;
	}

	.friend-card:nth-child(1) { animation-delay: 0.05s; }
	.friend-card:nth-child(2) { animation-delay: 0.1s; }
	.friend-card:nth-child(3) { animation-delay: 0.15s; }
	.friend-card:nth-child(4) { animation-delay: 0.2s; }
	.friend-card:nth-child(5) { animation-delay: 0.25s; }
	.friend-card:nth-child(6) { animation-delay: 0.3s; }

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* 搜索框焦点效果 */
	#friend-search:focus {
		box-shadow: 0 0 0 3px var(--primary) / 0.1;
	}
	
	/* 标签筛选按钮样式 - 与番剧页面一致 */
	.filter-container {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}
	
	.filter-tag {
		padding: 0.5rem 1rem;
		border: 1px solid var(--line-divider);
		border-radius: var(--radius-large);
		background: var(--btn-regular-bg);
		color: var(--btn-content);
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
		white-space: nowrap;
	}
	
	.filter-tag:hover:not(.active) {
		background: var(--btn-hover-bg);
		border-color: var(--primary);
		transform: translateY(-1px);
	}
	
	.filter-tag.active {
		background: var(--primary);
		color: white;
		border-color: var(--primary);
	}
	
	.filter-tag.active:hover {
		background: var(--primary) !important;
		color: white !important;
		border-color: var(--primary) !important;
		transform: translateY(-1px);
	}
</style>