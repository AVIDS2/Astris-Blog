---
/**
 * SSR 文章详情页 - 从 API 动态获取文章内容
 */
export const prerender = false;

import MainGridLayout from "../../layouts/MainGridLayout.astro";
import { fetchPost, fetchComments, type ApiPost, type ApiComment, getResourceUrl } from "../../utils/api-client";
import { Marked } from "marked";
import { markedHighlight } from "marked-highlight";
import hljs from "highlight.js";
import { Icon } from "astro-icon/components";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";

// 导入 Markdown 样式
import "../../styles/markdown.css";
import "../../styles/markdown-extend.styl";

// 创建配置了代码高亮的 marked 实例
const marked = new Marked(
	markedHighlight({
		langPrefix: 'hljs language-',
		highlight(code, lang) {
			const language = hljs.getLanguage(lang) ? lang : 'plaintext';
			return hljs.highlight(code, { language }).value;
		}
	})
);

// 获取 slug
const { slug } = Astro.params;

if (!slug) {
	return Astro.redirect('/404');
}

let post: ApiPost | null = null;
let comments: ApiComment[] = [];
let error: string | null = null;
let htmlContent = '';

try {
	post = await fetchPost(slug);
	// comments = await fetchComments(slug); // 评论功能已禁用
	
	// 渲染 Markdown
	if (post.content) {
		htmlContent = await marked.parse(post.content);
	}
} catch (e) {
	if (e instanceof Error && e.message === 'Post not found') {
		return Astro.redirect('/404');
	}
	error = e instanceof Error ? e.message : '获取文章失败';
	console.error('Failed to fetch post:', e);
}

// 格式化日期
const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleDateString('zh-CN', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	});
};
---

<MainGridLayout title={post?.title} description={post?.summary || undefined}>
	{error ? (
		<div class="card-base p-8 text-center">
			<Icon name="material-symbols:error-outline" class="text-4xl text-red-500 mb-4" />
			<p class="text-gray-500">{error}</p>
		</div>
	) : post && (
		<article class="card-base p-6 md:p-10">
			<!-- 文章头部 -->
			<header class="mb-8">
				<h1 class="text-3xl md:text-4xl font-bold mb-4 text-[var(--text-primary)]">
					{post.is_pinned && (
						<Icon name="mdi:pin" class="inline text-[var(--primary)] mr-2" />
					)}
					{post.title}
				</h1>
				
				<!-- 元信息 -->
				<div class="flex flex-wrap gap-4 text-sm text-gray-500 dark:text-gray-400">
					<span class="flex items-center gap-1">
						<Icon name="material-symbols:calendar-today-outline-rounded" class="text-base" />
						{formatDate(post.created_at)}
					</span>
					{post.category && (
						<a href={`/categories/${post.category.slug}/`} class="flex items-center gap-1 hover:text-[var(--primary)]">
							<Icon name="material-symbols:folder-outline-rounded" class="text-base" />
							{post.category.name}
						</a>
					)}
					<span class="flex items-center gap-1">
						<Icon name="material-symbols:visibility-outline-rounded" class="text-base" />
						{post.view_count} 次阅读
					</span>
				</div>
				
				<!-- 标签 -->
				{post.tags && post.tags.length > 0 && (
					<div class="flex flex-wrap gap-2 mt-4">
						{post.tags.map(tag => (
							<a 
								href={`/tags/${tag.slug}/`}
								class="text-xs px-3 py-1 rounded-full bg-[var(--primary)]/10 text-[var(--primary)] hover:bg-[var(--primary)]/20 transition"
							>
								# {tag.name}
							</a>
						))}
					</div>
				)}
			</header>
			
			<!-- 封面图 -->
			{post.cover_image && (
				<div class="mb-8 rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-800">
					<img 
						src={getResourceUrl(post.cover_image)} 
						alt={post.title}
						class="w-full h-auto object-cover"
						loading="lazy"
						decoding="async"
						fetchpriority="low"
						onerror="this.style.display='none'"
					/>
				</div>
			)}
			
			<!-- 文章内容 -->
			<div 
				class="prose prose-lg dark:prose-invert max-w-none custom-md"
				set:html={htmlContent}
			/>
			
			<!-- 文章底部 -->
			<footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
				<div class="flex justify-between items-center text-sm text-gray-500">
					<span>最后更新：{formatDate(post.updated_at)}</span>
					<span>作者：{post.author.username}</span>
				</div>
			</footer>
		</article>
	)}
	
	{/* 评论区已禁用 - 域名未备案，避免风险
	{post && (
		<section class="card-base p-6 md:p-10 mt-6">
			<h2 class="text-xl font-bold mb-6 flex items-center gap-2">
				<Icon name="material-symbols:chat-bubble-outline-rounded" class="text-2xl" />
				评论 ({post.comment_count})
			</h2>
			
			{comments.length > 0 ? (
				<div class="space-y-6">
					{comments.map(comment => (
						<div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800/50">
							<div class="flex items-center gap-2 mb-2">
								<span class="font-medium">{comment.nickname}</span>
								<span class="text-xs text-gray-400">{formatDate(comment.created_at)}</span>
							</div>
							<p class="text-gray-700 dark:text-gray-300">{comment.content}</p>
							
							{comment.replies && comment.replies.length > 0 && (
								<div class="mt-4 pl-4 border-l-2 border-gray-200 dark:border-gray-600 space-y-4">
									{comment.replies.map(reply => (
										<div>
											<div class="flex items-center gap-2 mb-1">
												<span class="font-medium text-sm">{reply.nickname}</span>
												<span class="text-xs text-gray-400">{formatDate(reply.created_at)}</span>
											</div>
											<p class="text-sm text-gray-600 dark:text-gray-400">{reply.content}</p>
										</div>
									))}
								</div>
							)}
						</div>
					))}
				</div>
			) : (
				<p class="text-gray-500 text-center py-8">暂无评论，来说点什么吧~</p>
			)}
			
			<div class="mt-8 p-6 rounded-lg bg-gray-50 dark:bg-gray-800/50">
				<h3 class="font-medium mb-4">发表评论</h3>
				<form id="comment-form" class="space-y-4">
					<input type="hidden" name="post_id" value={post.id} />
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<input 
							type="text" 
							name="nickname" 
							placeholder="昵称 *" 
							required
							class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
						/>
						<input 
							type="email" 
							name="email" 
							placeholder="邮箱（可选）"
							class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
						/>
					</div>
					<textarea 
						name="content" 
						placeholder="写下你的评论... *" 
						required
						rows="4"
						class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent resize-none"
					></textarea>
					<button 
						type="submit"
						class="px-6 py-2 rounded-lg bg-[var(--primary)] text-white font-medium hover:opacity-90 transition"
					>
						提交评论
					</button>
				</form>
			</div>
		</section>
	)}
	
	<div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-full bg-[var(--primary)] text-white font-medium opacity-0 -translate-y-4 transition-all duration-300 pointer-events-none">
		提交成功，评论已提交，待审核后将显示。
	</div>
	*/}
</MainGridLayout>

<script>
	// 轻量 Toast 提示
	function showToast(message: string, isError = false) {
		const toast = document.getElementById('toast');
		if (!toast) return;
		
		toast.textContent = message;
		toast.style.background = isError ? '#ef4444' : 'var(--primary)';
		
		// 显示
		toast.classList.remove('opacity-0', '-translate-y-4');
		toast.classList.add('opacity-100', 'translate-y-0');
		
		// 1.5秒后消失
		setTimeout(() => {
			toast.classList.remove('opacity-100', 'translate-y-0');
			toast.classList.add('opacity-0', '-translate-y-4');
		}, 1500);
	}

	// 评论提交处理
	const form = document.getElementById('comment-form') as HTMLFormElement;
	if (form) {
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const formData = new FormData(form);
			const data = {
				post_id: parseInt(formData.get('post_id') as string),
				nickname: formData.get('nickname') as string,
				email: formData.get('email') as string || undefined,
				content: formData.get('content') as string,
			};
			
			try {
				// 动态适配：开发环境用当前 IP:8000，生产环境用相对路径
				const isDev = import.meta.env?.DEV || (window.location.port === '4321');
				const API_BASE = isDev ? `http://${window.location.hostname}:8000` : '';
				const res = await fetch(`${API_BASE}/api/comments`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(data),
				});
				
				if (res.ok) {
					showToast('提交成功，评论已提交，待审核后将显示。');
					form.reset();
				} else {
					showToast('提交失败，请稍后重试', true);
				}
			} catch (err) {
				showToast('网络错误，请检查连接', true);
			}
		});
	}
</script>

<style>
	/* Markdown 内容样式增强 */
	.prose :global(pre) {
		background: var(--codeblock-bg);
		border-radius: 0.75rem;
		overflow-x: auto;
	}
	
	.prose :global(code) {
		background: rgba(0, 0, 0, 0.05);
		padding: 0.2em 0.4em;
		border-radius: 0.25rem;
		font-size: 0.9em;
	}
	
	.prose :global(pre code) {
		background: none;
		padding: 0;
	}
	
	.prose :global(img) {
		border-radius: 0.5rem;
	}
	
	.prose :global(blockquote) {
		border-left-color: var(--primary);
	}
</style>
